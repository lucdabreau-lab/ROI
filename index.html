<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Return on Investment Analysis | Procore Analytics</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Fonts: Importing Inter as the best available fallback for Google Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --procore-orange: #D95D2A;
            --procore-black: #1A1A1A;
            --procore-tan: #EAE3D9;
            --procore-offwhite: #F9F7F5;
            --brand-emerald: #10b981;
            --brand-blue: #2563EB;
        }

        body { 
            /* Prioritize Google Sans if available locally, otherwise use Inter */
            font-family: 'Google Sans', 'Inter', sans-serif; 
            background-color: var(--procore-offwhite);
            color: var(--procore-black);
            -webkit-font-smoothing: antialiased;
        }

        .tab-active {
            border-bottom: 4px solid var(--procore-orange);
            color: var(--procore-orange);
            font-weight: 800;
        }

        /* Custom Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus { outline: none; }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: var(--procore-tan);
            border-radius: 99px;
        }
        
        input[type=range]::-webkit-slider-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: var(--procore-orange);
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -7px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 2px solid white;
        }
        
        .slider-emerald::-webkit-slider-thumb { background: var(--brand-emerald) !important; }
        .slider-black::-webkit-slider-thumb { background: var(--procore-black) !important; }
        .slider-blue::-webkit-slider-thumb { background: var(--brand-blue) !important; }

        .card-shadow {
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
        }

        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            main { padding: 0; max-width: 100%; }
            .card-shadow { box-shadow: none; border: 1px solid #e5e7eb; }
            section { display: block !important; page-break-after: always; }
            #tab-navigation { display: none !important; }
            /* Ensure inputs look like text when printing */
            #company-name { border: none; background: transparent; padding: 0; }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Global Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-6 h-24 flex items-center justify-between">
            <div class="flex items-center gap-6">
                <!-- Branding Container -->
                <div class="flex items-center gap-4 bg-[#F9F7F5] p-2 px-3 rounded-2xl border border-[#EAE3D9]">
                    <!-- Company Logo Input (URL based) -->
                    <div class="group relative h-10 w-24 bg-gray-200 rounded flex items-center justify-center overflow-hidden" title="Paste URL to company logo">
                        <!-- Image Display Layer -->
                        <img id="company-logo-img" src="" class="absolute inset-0 h-full w-full object-contain hidden z-0">
                        
                        <!-- Input Layer -->
                        <input type="text" 
                               id="company-logo-input"
                               class="relative z-10 w-full h-full bg-transparent text-[10px] font-bold text-gray-500 placeholder-gray-500 text-center focus:outline-none focus:bg-white/90 transition-all opacity-100" 
                               placeholder="LOGO LINK" 
                               oninput="updateLogoFromUrl(this)">
                    </div>

                    <div class="w-px h-8 bg-[#EAE3D9]"></div>
                    <!-- Updated Procore Logo -->
                    <img src="https://media.ffycdn.net/us/procore/etmeNi2XofqcS5LaePER.png?width={width}" alt="Procore" class="h-8 w-auto object-contain">
                </div>
                <div class="flex flex-col justify-center">
                    <h1 class="font-black text-xl tracking-tight uppercase leading-none mb-1">Return on Investment</h1>
                    <!-- Company Name Input -->
                    <input type="text" id="company-name" 
                           class="bg-transparent text-xs font-bold text-slate-500 placeholder-slate-400 focus:outline-none focus:border-b focus:border-procore-orange transition-colors w-64 uppercase tracking-widest" 
                           placeholder="ENTER COMPANY NAME" 
                           value="JHL Constructors" 
                           oninput="updateCompanyName(this.value)">
                </div>
            </div>
            
            <button onclick="window.print()" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 hover:bg-black transition-all">
                <i data-lucide="printer" class="w-4 h-4"></i> Export Report
            </button>
        </div>
    </header>

    <!-- Navigation -->
    <nav id="tab-navigation" class="bg-white border-b border-gray-100 sticky top-24 z-40 no-print">
        <div class="max-w-7xl mx-auto px-6 flex gap-10 overflow-x-auto">
            <button onclick="switchTab('safety')" id="tab-safety" class="h-16 px-2 tab-active transition-all uppercase text-xs font-black tracking-widest whitespace-nowrap">Incident Reduction</button>
            <button onclick="switchTab('rework')" id="tab-rework" class="h-16 px-2 text-gray-400 transition-all uppercase text-xs font-black tracking-widest whitespace-nowrap">Rework Reduction</button>
            <button onclick="switchTab('schedule')" id="tab-schedule" class="h-16 px-2 text-gray-400 transition-all uppercase text-xs font-black tracking-widest whitespace-nowrap">Schedule Improvement</button>
            <button onclick="switchTab('summary')" id="tab-summary" class="h-16 px-2 text-gray-400 transition-all uppercase text-xs font-black tracking-widest whitespace-nowrap">Executive Summary</button>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-10">
        
        <!-- Tab 1: Safety ROI -->
        <section id="content-safety" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <aside class="lg:col-span-4 space-y-6">
                <!-- Main Inputs -->
                <div class="bg-white p-8 rounded-3xl border border-slate-200 card-shadow">
                    <div class="flex items-center gap-2 mb-8">
                        <div class="p-1.5 bg-[#EAE3D9] rounded-lg text-[#D95D2A]">
                            <i data-lucide="hard-hat" size="18"></i>
                        </div>
                        <h3 class="text-xs font-black uppercase tracking-widest text-slate-400">Safety Inputs</h3>
                    </div>
                    
                    <div class="space-y-10">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-3 text-sm">Annual Construction Volume</label>
                            <div class="relative rounded-2xl">
                                <span class="absolute left-5 top-1/2 -translate-y-1/2 text-[#D95D2A] font-bold text-lg">$</span>
                                <input id="input-annual-volume" type="text" class="w-full pl-10 pr-6 py-4 bg-[#F9F7F5] border border-[#EAE3D9] rounded-2xl focus:border-[#D95D2A] outline-none font-bold text-lg" value="100,000,000" oninput="formatVolumeInput(this)">
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <label class="text-sm font-bold text-slate-700">Estimated SG&A</label>
                                <span id="label-sga-pct" class="px-3 py-1 bg-[#EAE3D9] text-[#1A1A1A] rounded-full text-xs font-extrabold">7%</span>
                            </div>
                            <p class="text-xs text-slate-400 mb-3">Typical range of 10% to 12%</p>
                            <input id="input-sga-pct" type="range" min="0.01" max="0.20" step="0.01" value="0.07" class="slider-black">
                        </div>

                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <label class="text-sm font-bold text-slate-700">Labor Cost %</label>
                                <span id="label-labor-pct" class="px-3 py-1 bg-[#EAE3D9] text-[#D95D2A] rounded-full text-xs font-extrabold">25%</span>
                            </div>
                            <p class="text-xs text-slate-400 mb-3">25% average for subcontracted. 35% average for self perform</p>
                            <input id="input-labor-pct" type="range" min="0.1" max="0.6" step="0.01" value="0.25">
                        </div>

                        <div class="pt-4 border-t">
                            <div class="flex justify-between items-end mb-4">
                                <label class="text-sm font-bold text-emerald-700">Safety Improvement</label>
                                <span id="label-reduction-pct" class="px-3 py-1 bg-emerald-50 text-emerald-700 rounded-full text-xs font-extrabold">10%</span>
                            </div>
                            <!-- Updated min to 0.01 (1%) -->
                            <input id="input-reduction-pct" type="range" min="0.01" max="0.4" step="0.01" value="0.10" class="slider-emerald">
                        </div>
                    </div>
                </div>

                <!-- Benchmarks -->
                <div class="bg-[#1A1A1A] text-white p-8 rounded-3xl shadow-lg">
                    <div class="flex items-center gap-2 mb-8">
                        <i data-lucide="bar-chart-3" size="18" class="text-[#D95D2A]"></i>
                        <h4 class="text-xs font-black uppercase tracking-widest text-[#D95D2A]">Benchmarks</h4>
                    </div>
                    <div class="space-y-8">
                        <div>
                            <div class="flex justify-between items-end mb-3">
                                <label class="text-xs font-bold text-[#EAE3D9]">TRIR Benchmark</label>
                                <span id="label-trir-value" class="text-xs font-black px-2 py-0.5 bg-[#D95D2A] rounded text-white">2.3</span>
                            </div>
                            <input id="input-trir-value" type="range" min="0.5" max="3.0" step="0.1" value="2.3" class="slider-black">
                        </div>
                        <div>
                            <div class="flex justify-between items-end mb-3">
                                <label class="text-xs font-bold text-[#EAE3D9]">Cost per Recordable</label>
                                <span id="label-cost-recordable" class="text-xs font-black px-2 py-0.5 bg-[#D95D2A] rounded text-white">$43k</span>
                            </div>
                            <input id="input-cost-recordable" type="range" min="10000" max="90000" step="1000" value="43000" class="slider-black">
                        </div>
                    </div>
                </div>
            </aside>

            <main class="lg:col-span-8 flex flex-col justify-between">
                <div class="space-y-8">
                    <!-- Summary Metrics Hero Card -->
                    <div class="bg-emerald-600 rounded-[2.5rem] p-10 text-white relative overflow-hidden shadow-xl">
                        <div class="relative z-10">
                            <p class="text-white/80 font-bold uppercase tracking-widest text-xs mb-2">Target Annual Savings</p>
                            <h2 id="display-annual-savings" class="text-6xl font-black mb-4">$0</h2>
                            <p class="text-white/80 max-w-md text-sm leading-relaxed">
                                Reducing incident frequency lowers direct insurance liabilities, administrative burden, and lost labor productivity.
                            </p>
                        </div>
                        <!-- Changed watermark to Hard Hat for construction safety focus -->
                        <i data-lucide="hard-hat" class="absolute right-[-20px] bottom-[-20px] w-64 h-64 text-white/10 rotate-12"></i>
                    </div>

                    <!-- Secondary Metrics Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-8 rounded-2xl border border-slate-200 card-shadow text-center">
                            <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-1">Estimated Field FTEs</p>
                            <p id="display-ftes" class="text-3xl font-black text-slate-800">0</p>
                        </div>
                        <div class="bg-white p-8 rounded-2xl border border-slate-200 card-shadow text-center">
                            <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-1">Predicted Recordables</p>
                            <p id="display-incidents" class="text-3xl font-black text-slate-800">0</p>
                        </div>
                    </div>

                    <!-- Executive ROI Narrative -->
                    <div class="bg-white rounded-[2.5rem] border border-slate-200 card-shadow overflow-hidden">
                        <div class="p-8 md:p-12">
                            <h3 class="text-2xl font-black text-[#1A1A1A] mb-12 text-center">Safety ROI Narrative</h3>
                            <div class="space-y-12 relative">
                                <div class="flex gap-8 items-start relative z-10">
                                    <div class="w-12 h-12 bg-white rounded-2xl border-2 border-[#EAE3D9] flex items-center justify-center font-black text-[#D95D2A] shrink-0 shadow-sm">1</div>
                                    <div>
                                        <h4 class="font-black text-[#1A1A1A] text-lg uppercase tracking-tight">Resource Allocation</h4>
                                        <p class="text-slate-500 mt-2 leading-relaxed max-w-lg">
                                            With an annual volume of <span id="narrative-volume" class="font-bold text-[#D95D2A]">$0</span> and labor allocation of <span id="narrative-labor-pct" class="font-bold text-[#D95D2A]">25%</span>, <span class="company-name-text">JHL Constructors</span> manages approximately <span id="narrative-labor-cost" class="font-bold text-[#D95D2A]">$0</span> in field labor spend.
                                        </p>
                                    </div>
                                </div>
                                <div class="flex gap-8 items-start relative z-10">
                                    <div class="w-12 h-12 bg-white rounded-2xl border-2 border-[#EAE3D9] flex items-center justify-center font-black text-[#D95D2A] shrink-0 shadow-sm">2</div>
                                    <div>
                                        <h4 class="font-black text-[#1A1A1A] text-lg uppercase tracking-tight">Liability Exposure</h4>
                                        <p class="text-slate-500 mt-2 leading-relaxed max-w-lg">
                                            Accounting for <span id="narrative-sga-pct" class="font-bold text-[#1A1A1A]">7%</span> overhead and a TRIR of <span id="narrative-trir" class="font-bold text-[#1A1A1A]">2.3</span>, your sites carry an inherent liability of <span id="narrative-total-liability" class="font-black text-[#D95D2A]">$0</span> per year.
                                        </p>
                                    </div>
                                </div>
                                <div class="bg-emerald-50 rounded-3xl p-8 border border-emerald-100 flex items-center gap-8 relative z-10">
                                    <div class="p-4 bg-emerald-500 rounded-2xl text-white shadow-lg"><i data-lucide="trending-up" size="32"></i></div>
                                    <div>
                                        <h4 class="text-2xl font-black text-emerald-900 leading-tight">Projected Annual Capture</h4>
                                        <p class="text-emerald-700 mt-1">Driving a <span id="narrative-reduction-pct" class="font-black underline decoration-4 decoration-emerald-200">10%</span> incident reduction recovers:</p>
                                        <div id="narrative-annual-savings" class="text-4xl font-black text-emerald-600 mt-3">$0</div>
                                    </div>
                                </div>
                                <div class="absolute left-6 top-6 bottom-32 w-1 bg-[#EAE3D9] -z-0 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footnotes for Tab 1 -->
                <div class="mt-8 pt-8 border-t border-slate-200 text-xs text-slate-400 space-y-2">
                    <p class="font-bold uppercase tracking-wider mb-2 text-slate-500">Methodology & References</p>
                    <p>
                        <span class="font-bold text-slate-600">Estimated FTEs:</span> Derived from field labor spend. 
                        <a href="https://constructioncoverage.com/glossary/labor-burden" target="_blank" class="underline hover:text-[#D95D2A] transition-colors">Construction Coverage Labor Burden</a>
                    </p>
                    <p>
                        <span class="font-bold text-slate-600">Labor Cost Benchmarks:</span> Average provided by 
                        <a href="https://www.ciranalytics.com/clma" target="_blank" class="underline hover:text-[#D95D2A] transition-colors">Construction Labor Market Analyzer</a>
                    </p>
                    <p>
                        <span class="font-bold text-slate-600">SG&A Benchmarks:</span> 
                        <a href="https://cfma.org/articles/cfma-s-2-24-construction-financial-benchmarker-executive-summary" target="_blank" class="underline hover:text-[#D95D2A] transition-colors">CFMA Financial Benchmarker</a>
                    </p>
                    <p>
                        <span class="font-bold text-slate-600">TRIR Benchmark:</span> Based on industry incidence rates. 
                        <a href="https://www.bls.gov/iif/" target="_blank" class="underline hover:text-[#D95D2A] transition-colors">Bureau of Labor Statistics (BLS)</a>
                    </p>
                    <p>
                        <span class="font-bold text-slate-600">Cost per Recordable:</span> Average cost per medically consulted injury. 
                        <a href="https://injuryfacts.nsc.org/work/costs/work-injury-costs/" target="_blank" class="underline hover:text-[#D95D2A] transition-colors">National Safety Council (NSC) Injury Facts</a>
                    </p>
                </div>
            </main>
        </section>

        <!-- Tab 2: Rework Reduction -->
        <section id="content-rework" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-8 rounded-3xl border border-slate-200 card-shadow">
                    <h2 class="text-lg font-bold mb-6 flex items-center gap-2"><i data-lucide="wrench" class="w-5 h-5 text-[#D95D2A]"></i> Rework Variables</h2>
                    <div class="space-y-8">
                        
                        <!-- NEW Annual Volume Input for Tab 2 -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-3 text-sm">Annual Construction Volume</label>
                            <div class="relative rounded-2xl">
                                <span class="absolute left-5 top-1/2 -translate-y-1/2 text-[#D95D2A] font-bold text-lg">$</span>
                                <input id="input-annual-volume-rework" type="text" class="w-full pl-10 pr-6 py-4 bg-[#F9F7F5] border border-[#EAE3D9] rounded-2xl focus:border-[#D95D2A] outline-none font-bold text-lg" value="100,000,000" oninput="formatVolumeInput(this)">
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-semibold text-gray-600">Total Rework % of Volume</label>
                                <span id="val-rw-pct" class="text-sm font-bold text-[#D95D2A]">2.5%</span>
                            </div>
                            <p class="text-xs text-slate-400 mb-3">12% average. Ranges from 2% to 20%</p>
                            <input type="range" id="input-rw-pct" min="0.5" max="15" step="0.1" value="2.5">
                        </div>
                        
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-semibold text-gray-600">Estimated Nonrecoverable</label>
                                <span id="val-rw-non" class="text-sm font-bold text-[#D95D2A]">70%</span>
                            </div>
                            <p class="text-xs text-slate-400 mb-3">70% average</p>
                            <input type="range" id="input-rw-non" min="50" max="100" step="5" value="70">
                        </div>

                        <div class="pt-4 border-t">
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-semibold text-emerald-700">Rework Reduction Target</label>
                                <span id="val-rw-red" class="text-sm font-bold text-emerald-600">5.0%</span>
                            </div>
                            <input type="range" id="input-rw-red" min="1" max="25" step="1" value="5.0" class="slider-emerald">
                        </div>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-8 space-y-8">
                <!-- Hero Card: Annual Profit Recovery (Green) -->
                <div class="bg-emerald-600 rounded-[2.5rem] p-10 text-white relative overflow-hidden shadow-xl">
                    <div class="relative z-10">
                        <p class="text-white/80 font-bold uppercase tracking-widest text-xs mb-2">Annual Profit Recovery</p>
                        <h2 id="display-rw-savings" class="text-6xl font-black mb-4">$0</h2>
                        <p class="text-white/80 max-w-md text-sm leading-relaxed">
                            Mitigating direct rework costs through automated QA/QC, real-time field visibility, and integrated coordination workflows.
                        </p>
                    </div>
                    <i data-lucide="trending-up" class="absolute right-[-20px] bottom-[-20px] w-64 h-64 text-white/10 rotate-12"></i>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 card-shadow text-center">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-1">Liability Exposure</p>
                        <p id="display-rw-exposure" class="text-3xl font-black text-slate-800">$0</p>
                    </div>
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 card-shadow text-center">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-1">Profit Margin Impact</p>
                        <p id="display-rw-profit" class="text-3xl font-black text-emerald-600">+0.00%</p>
                    </div>
                </div>

                <!-- Rework ROI Narrative -->
                <div class="bg-white rounded-[2.5rem] border border-slate-200 card-shadow overflow-hidden">
                    <div class="p-8 md:p-12">
                        <h3 class="text-2xl font-black text-[#1A1A1A] mb-12 text-center">Rework ROI Narrative</h3>
                        <div class="space-y-12 relative">
                            <!-- Step 1 -->
                            <div class="flex gap-8 items-start relative z-10">
                                <div class="w-12 h-12 bg-white rounded-2xl border-2 border-[#EAE3D9] flex items-center justify-center font-black text-[#D95D2A] shrink-0 shadow-sm">1</div>
                                <div>
                                    <h4 class="font-black text-[#1A1A1A] text-lg uppercase tracking-tight">Financial Footprint</h4>
                                    <p class="text-slate-500 mt-2 leading-relaxed max-w-lg">
                                        Based on an annual construction volume of <span id="narrative-rw-vol" class="font-bold text-[#D95D2A]">$0</span> and an estimated rework rate of <span id="narrative-rw-pct" class="font-bold text-[#D95D2A]">2.5%</span>, your total rework volume is approximately <span id="narrative-rw-total" class="font-bold text-[#D95D2A]">$0</span>.
                                    </p>
                                </div>
                            </div>
                            <!-- Step 2 -->
                            <div class="flex gap-8 items-start relative z-10">
                                <div class="w-12 h-12 bg-white rounded-2xl border-2 border-[#EAE3D9] flex items-center justify-center font-black text-[#D95D2A] shrink-0 shadow-sm">2</div>
                                <div>
                                    <h4 class="font-black text-[#1A1A1A] text-lg uppercase tracking-tight">The Profit Leak</h4>
                                    <p class="text-slate-500 mt-2 leading-relaxed max-w-lg">
                                        Accounting for a <span id="narrative-rw-non" class="font-bold text-[#1A1A1A]">70%</span> nonrecoverable rate, <span class="company-name-text">JHL Constructors</span> absorbs <span id="narrative-rw-exposure" class="font-black text-[#D95D2A]">$0</span> in annual direct profit erosion.
                                    </p>
                                </div>
                            </div>
                            <!-- Step 3 -->
                            <div class="bg-emerald-50 rounded-3xl p-8 border border-emerald-100 flex items-center gap-8 relative z-10">
                                <div class="p-4 bg-emerald-500 rounded-2xl text-white shadow-lg"><i data-lucide="check-circle" size="32"></i></div>
                                <div>
                                    <h4 class="text-2xl font-black text-emerald-900 leading-tight">Net Capital Recovery</h4>
                                    <p class="text-emerald-700 mt-1">Driving a <span id="narrative-rw-red" class="font-black underline decoration-4 decoration-emerald-200">5%</span> improvement in quality capture recovers:</p>
                                    <div id="narrative-rw-savings" class="text-4xl font-black text-emerald-600 mt-3">$0</div>
                                </div>
                            </div>
                            <div class="absolute left-6 top-6 bottom-32 w-1 bg-[#EAE3D9] -z-0 rounded-full"></div>
                        </div>
                    </div>
                </div>

                <!-- Footnotes for Tab 2 -->
                <div class="mt-8 pt-8 border-t border-slate-200 text-xs text-slate-400 space-y-2">
                    <p class="font-bold uppercase tracking-wider mb-2 text-slate-500">Methodology & References</p>
                    <p>
                        <span class="font-bold text-slate-600">Total Rework % of Volume:</span> Benchmarks for rework cost relative to Total Installed Cost. 
                        <a href="https://becht.com/becht-blog/entry/measuring-construction-rework-delays-in-sustaining-capital-projects/" target="_blank" class="underline hover:text-[#D95D2A] transition-colors">Becht Engineering Analysis</a>
                    </p>
                    <p>
                        <span class="font-bold text-slate-600">Estimated Nonrecoverable:</span> Portion of rework costs not recoverable via insurance/back-charges. 
                        <a href="https://www.procore.com/ebooks/global-state-of-preconstruction" target="_blank" class="underline hover:text-[#D95D2A] transition-colors">Procore Global State of Preconstruction</a>
                    </p>
                </div>
            </div>
        </section>

        <!-- Tab 3: Schedule & Overhead (NEW REPLACEMENT) -->
        <section id="content-schedule" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-8 rounded-3xl border border-slate-200 card-shadow">
                    <h2 class="text-lg font-bold mb-6 flex items-center gap-2"><i data-lucide="calendar-clock" class="w-5 h-5 text-emerald-600"></i> Schedule Variables</h2>
                    <div class="space-y-8">
                        
                        <!-- NEW Annual Volume Input for Tab 3 -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-3 text-sm">Annual Construction Volume</label>
                            <div class="relative rounded-2xl">
                                <!-- Styled with Emerald/Green for Tab 3 consistency -->
                                <span class="absolute left-5 top-1/2 -translate-y-1/2 text-emerald-600 font-bold text-lg">$</span>
                                <input id="input-annual-volume-schedule" type="text" class="w-full pl-10 pr-6 py-4 bg-[#F9F7F5] border border-[#EAE3D9] rounded-2xl focus:border-emerald-600 outline-none font-bold text-lg" value="100,000,000" oninput="formatVolumeInput(this)">
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-semibold text-gray-600">General Conditions %</label>
                                <span id="val-gc-pct" class="text-sm font-bold text-emerald-600">8%</span>
                            </div>
                            <p class="text-xs text-slate-400 mb-3">Range of 6% to 12%</p>
                            <input type="range" id="input-gc-pct" min="1" max="15" step="0.5" value="8" class="slider-emerald">
                        </div>
                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-sm font-semibold text-gray-600">Avg Project Duration (Mo)</label>
                                <span id="val-duration" class="text-sm font-bold text-emerald-600">12</span>
                            </div>
                            <input type="range" id="input-duration" min="6" max="36" step="1" value="12" class="slider-emerald">
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-semibold text-gray-600">Avg Schedule Slippage</label>
                                <span id="val-slippage" class="text-sm font-bold text-emerald-600">15%</span>
                            </div>
                            <p class="text-xs text-slate-400 mb-3">72% of projects are delayed 38% on average</p>
                            <input type="range" id="input-slippage" min="0" max="50" step="5" value="15" class="slider-emerald">
                        </div>
                        <div class="pt-4 border-t">
                            <div class="flex justify-between mb-2">
                                <label class="text-sm font-semibold text-emerald-700">Delay Reduction Target</label>
                                <span id="val-sched-red" class="text-sm font-bold text-emerald-600">10%</span>
                            </div>
                            <input type="range" id="input-sched-red" min="1" max="30" step="1" value="10" class="slider-emerald">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-8 space-y-6">
                <div class="bg-emerald-600 rounded-[2.5rem] p-10 text-white relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-emerald-100 font-bold uppercase tracking-widest text-xs mb-2">Schedule & Overhead Savings</p>
                        <h2 id="display-sched-savings" class="text-6xl font-black mb-4">$0</h2>
                        <p class="text-emerald-100/80 max-w-md text-sm leading-relaxed">
                            Proactively mitigating schedule delays reduces the non-reimbursable burn of General Conditions and limits exposure to liquidated damages.
                        </p>
                    </div>
                    <i data-lucide="hourglass" class="absolute right-[-20px] bottom-[-20px] w-64 h-64 text-white/10 rotate-12"></i>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 card-shadow text-center">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-1">Daily Burn Rate</p>
                        <p id="display-burn-rate" class="text-3xl font-black text-slate-800">$0</p>
                        <p class="text-xs text-slate-400 mt-2">Cost per day of General Conditions</p>
                    </div>
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 card-shadow text-center">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-1">Total Overrun Liability</p>
                        <p id="display-overrun-cost" class="text-3xl font-black text-[#D95D2A]">$0</p>
                        <p class="text-xs text-slate-400 mt-2">Direct GC slip + weighted claim risk<br>(25.7% frequency Ã— 2% volume)</p>
                    </div>
                </div>

                <!-- Schedule ROI Narrative (NEW ADDITION) -->
                <div class="bg-white rounded-[2.5rem] border border-slate-200 card-shadow overflow-hidden">
                    <div class="p-8 md:p-12">
                        <h3 class="text-2xl font-black text-[#1A1A1A] mb-12 text-center">Schedule ROI Narrative</h3>
                        <div class="space-y-12 relative">
                            <!-- Step 1 -->
                            <div class="flex gap-8 items-start relative z-10">
                                <div class="w-12 h-12 bg-white rounded-2xl border-2 border-[#EAE3D9] flex items-center justify-center font-black text-[#D95D2A] shrink-0 shadow-sm">1</div>
                                <div>
                                    <h4 class="font-black text-[#1A1A1A] text-lg uppercase tracking-tight">The Burn Rate</h4>
                                    <p class="text-slate-500 mt-2 leading-relaxed max-w-lg">
                                        With General Conditions set at <span id="narrative-sched-gc-pct" class="font-bold text-[#D95D2A]">8%</span> of your <span id="narrative-sched-vol" class="font-bold text-[#D95D2A]">$100M</span> volume, your project sites burn <span id="narrative-sched-daily-burn" class="font-bold text-[#D95D2A]">$22k</span> every single calendar day.
                                    </p>
                                </div>
                            </div>
                            <!-- Step 2 -->
                            <div class="flex gap-8 items-start relative z-10">
                                <div class="w-12 h-12 bg-white rounded-2xl border-2 border-[#EAE3D9] flex items-center justify-center font-black text-[#D95D2A] shrink-0 shadow-sm">2</div>
                                <div>
                                    <h4 class="font-black text-[#1A1A1A] text-lg uppercase tracking-tight">The Overrun Risk</h4>
                                    <p class="text-slate-500 mt-2 leading-relaxed max-w-lg">
                                        A typical <span id="narrative-sched-duration" class="font-bold text-[#1A1A1A]">12</span> month project slipping by <span id="narrative-sched-slippage" class="font-bold text-[#1A1A1A]">15%</span> creates an immediate liability of <span id="narrative-sched-overrun" class="font-black text-[#D95D2A]">$1.2M</span> in non-recoverable overhead (excluding claim risks).
                                    </p>
                                </div>
                            </div>
                            <!-- Step 3 -->
                            <div class="bg-emerald-50 rounded-3xl p-8 border border-emerald-100 flex items-center gap-8 relative z-10">
                                <div class="p-4 bg-emerald-500 rounded-2xl text-white shadow-lg"><i data-lucide="hourglass" size="32"></i></div>
                                <div>
                                    <h4 class="text-2xl font-black text-emerald-900 leading-tight">Efficiency Dividend</h4>
                                    <p class="text-emerald-700 mt-1">Improving schedule efficiency by <span id="narrative-sched-red" class="font-black underline decoration-4 decoration-emerald-200">10%</span> recaptures:</p>
                                    <div id="narrative-sched-savings" class="text-4xl font-black text-emerald-600 mt-3">$0</div>
                                </div>
                            </div>
                            <div class="absolute left-6 top-6 bottom-32 w-1 bg-[#EAE3D9] -z-0 rounded-full"></div>
                        </div>
                    </div>
                </div>

                <!-- Footnotes for Tab 3 -->
                <div class="mt-8 pt-8 border-t border-slate-200 text-xs text-slate-400 space-y-2">
                    <p class="font-bold uppercase tracking-wider mb-2 text-slate-500">Methodology & References</p>
                    <p>
                        <span class="font-bold text-slate-600">General Conditions Benchmarks:</span> 
                        <a href="https://cfma.org/articles/cfma-s-2-24-construction-financial-benchmarker-executive-summary" target="_blank" class="underline hover:text-[#D95D2A] transition-colors">CFMA Financial Benchmarker</a>
                    </p>
                    <p>
                        <span class="font-bold text-slate-600">Average settled claim of 2%:</span> Benchmark for claim value relative to project volume. 
                        <a href="https://www.foundamental.com/perspectives/disputes-in-construction" target="_blank" class="underline hover:text-[#D95D2A] transition-colors">Foundamental Perspectives</a>
                    </p>
                    <p>
                        <span class="font-bold text-slate-600">Frequency of claims:</span> Analysis of claim occurrence rates. 
                        <a href="https://www.nationalacademies.org/read/11846/chapter/9" target="_blank" class="underline hover:text-[#D95D2A] transition-colors">National Academies Report</a>
                    </p>
                    <p>
                        <span class="font-bold text-slate-600">Scope change impact:</span> Impact conflicts affect 25.7% of disputed projects. 
                        <a href="https://www.constructiondive.com/news/time-money-fewer-construction-disputes-americas/808089/" target="_blank" class="underline hover:text-[#D95D2A] transition-colors">Construction Dive</a>
                    </p>
                </div>

            </div>
        </section>

        <!-- Tab 4: Summary -->
        <section id="content-summary" class="hidden space-y-8">
            
            <!-- Value Stream Toggles -->
            <div class="flex flex-wrap justify-center gap-8 mb-4 bg-white p-4 rounded-3xl border border-slate-200 card-shadow w-fit mx-auto no-print">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggle-safety" class="sr-only peer" checked onchange="calculate(); renderChart();">
                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#D95D2A]"></div>
                    <span class="ms-3 text-sm font-bold text-gray-700">Incident Reduction</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggle-rework" class="sr-only peer" checked onchange="calculate(); renderChart();">
                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#1A1A1A]"></div>
                    <span class="ms-3 text-sm font-bold text-gray-700">Rework Reduction</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggle-schedule" class="sr-only peer" checked onchange="calculate(); renderChart();">
                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#EAE3D9]"></div>
                    <span class="ms-3 text-sm font-bold text-gray-700">Schedule Improvement</span>
                </label>
            </div>

            <!-- Investment Inputs (New) -->
            <div class="bg-white p-6 rounded-3xl border border-slate-200 card-shadow max-w-4xl mx-auto">
                <h4 class="text-xs font-black uppercase tracking-widest text-slate-400 mb-4"><span class="company-name-text">JHL Constructors</span> Investment</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-2">Annual Software Investment</label>
                        <div class="relative rounded-xl">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">$</span>
                            <input id="input-invest-annual" type="text" class="w-full pl-8 pr-4 py-3 bg-[#F9F7F5] border border-[#EAE3D9] rounded-xl focus:border-[#D95D2A] outline-none font-bold text-slate-700" value="50,000" oninput="formatCurrencyInput(this)">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-2">One-Time Professional Services</label>
                        <div class="relative rounded-xl">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">$</span>
                            <input id="input-invest-onetime" type="text" class="w-full pl-8 pr-4 py-3 bg-[#F9F7F5] border border-[#EAE3D9] rounded-xl focus:border-[#D95D2A] outline-none font-bold text-slate-700" value="10,000" oninput="formatCurrencyInput(this)">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Changed grid from cols-2 to cols-3 to accommodate ROI card -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-8 rounded-3xl border border-slate-200 card-shadow text-center">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-2">Total Year 1 Realization</p>
                    <h3 id="summary-total-savings" class="text-4xl font-black text-[#D95D2A]">$0</h3>
                </div>
                <div class="bg-white p-8 rounded-3xl border border-slate-200 card-shadow text-center">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-2">Year 1 ROI</p>
                    <!-- Changed text color to emerald (green) -->
                    <h3 id="summary-roi-y1" class="text-4xl font-black text-emerald-600">0%</h3>
                </div>
                <div class="bg-white p-8 rounded-3xl border border-slate-200 card-shadow text-center">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-2">3-Year Cumulative Value</p>
                    <h3 id="summary-total-3yr" class="text-4xl font-black text-emerald-600">$0</h3>
                </div>
            </div>
            <div class="bg-white p-10 rounded-3xl border border-slate-200 card-shadow">
                <h3 class="text-xl font-bold mb-8">Value Realization Growth Projection</h3>
                <div class="h-96"><canvas id="roiChart"></canvas></div>
            </div>
        </section>

    </main>

    <script>
        // Utilities
        const toCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
        const toShort = (val) => val >= 1e6 ? '$' + (val/1e6).toFixed(1) + 'M' : val >= 1e3 ? '$' + Math.round(val/1e3) + 'k' : '$' + val;

        let roiChart = null;
        const state = { safety: 0, rework: 0, schedule: 0, roi: [0,0,0] };

        function switchTab(tab) {
            ['safety', 'rework', 'schedule', 'summary'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).className = 'h-16 px-2 text-gray-400 transition-all uppercase text-xs font-black tracking-widest whitespace-nowrap';
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).className = 'h-16 px-2 tab-active transition-all uppercase text-xs font-black tracking-widest whitespace-nowrap';
            if (tab === 'summary') renderChart();
        }

        // Modified function to sync volume inputs across all tabs
        function formatVolumeInput(input) {
            // Remove non-digit chars
            let rawValue = input.value.replace(/\D/g, '');
            if (rawValue === '') {
                calculate();
                return;
            }
            // Format with commas
            const formatted = Number(rawValue).toLocaleString();
            
            // Update all volume inputs to stay in sync
            const volInputs = [
                document.getElementById('input-annual-volume'),
                document.getElementById('input-annual-volume-rework'),
                document.getElementById('input-annual-volume-schedule')
            ];
            
            volInputs.forEach(el => {
                if (el && el !== input) {
                    el.value = formatted;
                }
            });

            input.value = formatted;
            calculate();
        }

        // Generic currency formatter for investment inputs (no syncing)
        function formatCurrencyInput(input) {
            let rawValue = input.value.replace(/\D/g, '');
            if (rawValue === '') {
                calculate();
                return;
            }
            input.value = Number(rawValue).toLocaleString();
            calculate();
        }

        // Update company name text throughout dashboard
        function updateCompanyName(name) {
            const companyName = name.trim() || 'The Company';
            document.querySelectorAll('.company-name-text').forEach(el => {
                el.innerText = companyName;
            });
        }

        // Handle logo URL input
        function updateLogoFromUrl(input) {
            const url = input.value.trim();
            const img = document.getElementById('company-logo-img');
            
            if (url.length > 5) { // Basic length check to avoid breaking on single chars
                img.src = url;
                
                // Add error handler in case URL is bad
                img.onerror = function() {
                    img.classList.add('hidden');
                    input.classList.remove('opacity-0', 'hover:opacity-100', 'focus:opacity-100');
                };
                
                img.onload = function() {
                    img.classList.remove('hidden');
                    // When image loads successfully, hide the input unless hovered
                    input.classList.add('opacity-0', 'hover:opacity-100', 'focus:opacity-100');
                };
            } else {
                img.classList.add('hidden');
                input.classList.remove('opacity-0', 'hover:opacity-100', 'focus:opacity-100');
            }
        }

        function calculate() {
            // Helper to safely get value from an input ID, defaulting to 0 if missing or empty
            const getVal = (id) => {
                const el = document.getElementById(id);
                if (!el) return 0;
                // Clean commas if present
                return parseFloat(el.value.replace(/,/g, '')) || 0;
            };

            // Safe volume retrieval (handles commas and missing elements)
            let vol = 0;
            const volInput1 = document.getElementById('input-annual-volume');
            if (volInput1) {
                vol = parseFloat(volInput1.value.replace(/,/g, '')) || 0;
            } else {
                // Fallback to others if Tab 1 input missing
                const volInput2 = document.getElementById('input-annual-volume-rework');
                const volInput3 = document.getElementById('input-annual-volume-schedule');
                if (volInput2) vol = parseFloat(volInput2.value.replace(/,/g, '')) || 0;
                else if (volInput3) vol = parseFloat(volInput3.value.replace(/,/g, '')) || 0;
            }

            // --- Safety Logic ---
            const sgaPct = getVal('input-sga-pct');
            const lPct = getVal('input-labor-pct');
            const safetyRed = getVal('input-reduction-pct');
            const trir = getVal('input-trir-value');
            const costPerRecordable = getVal('input-cost-recordable');
            
            const totalLaborCost = vol * lPct;
            const fieldLaborSpend = totalLaborCost * (1 - sgaPct);
            const ftes = fieldLaborSpend / 100800;
            const incidents = (ftes / 100) * trir;
            const safetyLiability = incidents * costPerRecordable;
            state.safety = safetyLiability * safetyRed;

            // UI Updates - Safety
            if (document.getElementById('label-sga-pct')) document.getElementById('label-sga-pct').innerText = Math.round(sgaPct * 100) + '%';
            if (document.getElementById('label-labor-pct')) document.getElementById('label-labor-pct').innerText = Math.round(lPct * 100) + '%';
            if (document.getElementById('label-reduction-pct')) document.getElementById('label-reduction-pct').innerText = Math.round(safetyRed * 100) + '%';
            if (document.getElementById('label-trir-value')) document.getElementById('label-trir-value').innerText = trir.toFixed(1);
            if (document.getElementById('label-cost-recordable')) document.getElementById('label-cost-recordable').innerText = toShort(costPerRecordable);
            
            if (document.getElementById('display-annual-savings')) document.getElementById('display-annual-savings').innerText = toCurrency(state.safety);
            if (document.getElementById('display-ftes')) document.getElementById('display-ftes').innerText = Math.round(ftes).toLocaleString();
            if (document.getElementById('display-incidents')) document.getElementById('display-incidents').innerText = incidents.toFixed(1);
            
            if (document.getElementById('narrative-volume')) document.getElementById('narrative-volume').innerText = toCurrency(vol);
            if (document.getElementById('narrative-labor-pct')) document.getElementById('narrative-labor-pct').innerText = Math.round(lPct * 100) + '%';
            if (document.getElementById('narrative-labor-cost')) document.getElementById('narrative-labor-cost').innerText = toCurrency(totalLaborCost);
            if (document.getElementById('narrative-sga-pct')) document.getElementById('narrative-sga-pct').innerText = Math.round(sgaPct * 100) + '%';
            if (document.getElementById('narrative-trir')) document.getElementById('narrative-trir').innerText = trir.toFixed(1);
            if (document.getElementById('narrative-total-liability')) document.getElementById('narrative-total-liability').innerText = toCurrency(safetyLiability);
            if (document.getElementById('narrative-reduction-pct')) document.getElementById('narrative-reduction-pct').innerText = Math.round(safetyRed * 100) + '%';
            if (document.getElementById('narrative-annual-savings')) document.getElementById('narrative-annual-savings').innerText = toCurrency(state.safety);

            // --- Rework Logic ---
            const rwPct = getVal('input-rw-pct') / 100;
            const rwNon = getVal('input-rw-non') / 100;
            const rwRed = getVal('input-rw-red') / 100;
            
            const totalReworkExposure = (vol * rwPct) * rwNon;
            state.rework = totalReworkExposure * rwRed;

            if (document.getElementById('val-rw-pct')) document.getElementById('val-rw-pct').innerText = (rwPct * 100).toFixed(1) + '%';
            if (document.getElementById('val-rw-non')) document.getElementById('val-rw-non').innerText = Math.round(rwNon * 100) + '%';
            if (document.getElementById('val-rw-red')) document.getElementById('val-rw-red').innerText = (rwRed * 100).toFixed(1) + '%';
            
            if (document.getElementById('display-rw-savings')) document.getElementById('display-rw-savings').innerText = toCurrency(state.rework);
            if (document.getElementById('display-rw-exposure')) document.getElementById('display-rw-exposure').innerText = toCurrency(totalReworkExposure);
            if (document.getElementById('display-rw-profit')) document.getElementById('display-rw-profit').innerText = '+' + (vol > 0 ? ((state.rework / vol) * 100).toFixed(2) : '0.00') + '%';

            if (document.getElementById('narrative-rw-vol')) document.getElementById('narrative-rw-vol').innerText = toCurrency(vol);
            if (document.getElementById('narrative-rw-pct')) document.getElementById('narrative-rw-pct').innerText = (rwPct * 100).toFixed(1) + '%';
            if (document.getElementById('narrative-rw-total')) document.getElementById('narrative-rw-total').innerText = toCurrency(vol * rwPct);
            if (document.getElementById('narrative-rw-non')) document.getElementById('narrative-rw-non').innerText = Math.round(rwNon * 100) + '%';
            if (document.getElementById('narrative-rw-exposure')) document.getElementById('narrative-rw-exposure').innerText = toCurrency(totalReworkExposure);
            if (document.getElementById('narrative-rw-red')) document.getElementById('narrative-rw-red').innerText = (rwRed * 100).toFixed(1) + '%';
            if (document.getElementById('narrative-rw-savings')) document.getElementById('narrative-rw-savings').innerText = toCurrency(state.rework);

            // --- Schedule Logic ---
            const gcPct = getVal('input-gc-pct') / 100;
            const durationMo = getVal('input-duration');
            const slippagePct = getVal('input-slippage') / 100;
            const schedRed = getVal('input-sched-red') / 100;

            const totalGcCost = vol * gcPct;
            const durationDays = durationMo * 30; // Approx
            const dailyBurn = durationDays > 0 ? totalGcCost / durationDays : 0;
            
            const overrunDays = durationDays * slippagePct;
            const overrunCost = overrunDays * dailyBurn;
            
            // Updated Claim Risk Calculation: 25.7% frequency * 2% avg claim value * volume
            const claimExposure = vol * 0.02 * 0.257; 
            
            const totalScheduleExposure = overrunCost + claimExposure;
            state.schedule = totalScheduleExposure * schedRed;

            // Schedule UI
            if (document.getElementById('val-gc-pct')) document.getElementById('val-gc-pct').innerText = (gcPct * 100).toFixed(1) + '%';
            if (document.getElementById('val-duration')) document.getElementById('val-duration').innerText = durationMo;
            if (document.getElementById('val-slippage')) document.getElementById('val-slippage').innerText = (slippagePct * 100).toFixed(0) + '%';
            if (document.getElementById('val-sched-red')) document.getElementById('val-sched-red').innerText = (schedRed * 100).toFixed(0) + '%';
            
            if (document.getElementById('display-sched-savings')) document.getElementById('display-sched-savings').innerText = toCurrency(state.schedule);
            if (document.getElementById('display-burn-rate')) document.getElementById('display-burn-rate').innerText = toCurrency(dailyBurn);
            if (document.getElementById('display-overrun-cost')) document.getElementById('display-overrun-cost').innerText = toCurrency(totalScheduleExposure);

            // Narrative Update for Schedule
            if (document.getElementById('narrative-sched-vol')) document.getElementById('narrative-sched-vol').innerText = toShort(vol);
            if (document.getElementById('narrative-sched-gc-pct')) document.getElementById('narrative-sched-gc-pct').innerText = (gcPct * 100).toFixed(1) + '%';
            if (document.getElementById('narrative-sched-daily-burn')) document.getElementById('narrative-sched-daily-burn').innerText = toCurrency(dailyBurn);
            if (document.getElementById('narrative-sched-duration')) document.getElementById('narrative-sched-duration').innerText = durationMo;
            if (document.getElementById('narrative-sched-slippage')) document.getElementById('narrative-sched-slippage').innerText = (slippagePct * 100).toFixed(0) + '%';
            if (document.getElementById('narrative-sched-overrun')) document.getElementById('narrative-sched-overrun').innerText = toCurrency(overrunCost); // Narrative focused on direct overrun
            if (document.getElementById('narrative-sched-red')) document.getElementById('narrative-sched-red').innerText = (schedRed * 100).toFixed(0) + '%';
            if (document.getElementById('narrative-sched-savings')) document.getElementById('narrative-sched-savings').innerText = toCurrency(state.schedule);


            // --- Global Summary ---
            // Check toggles (if they exist, default to true)
            const sTog = document.getElementById('toggle-safety');
            const rTog = document.getElementById('toggle-rework');
            const scTog = document.getElementById('toggle-schedule');
            
            const sOn = sTog ? sTog.checked : true;
            const rOn = rTog ? rTog.checked : true;
            const scOn = scTog ? scTog.checked : true;

            // Raw Savings Per Year (using growth factors from chart logic)
            const savingsY1 = (sOn ? state.safety : 0) + (rOn ? state.rework : 0) + (scOn ? state.schedule : 0);
            const savingsY2 = (sOn ? state.safety * 1.1 : 0) + (rOn ? state.rework * 1.1 : 0) + (scOn ? state.schedule * 1.1 : 0);
            const savingsY3 = (sOn ? state.safety * 1.25 : 0) + (rOn ? state.rework * 1.25 : 0) + (scOn ? state.schedule * 1.25 : 0);

            // Investments
            const investAnnual = getVal('input-invest-annual');
            const investOneTime = getVal('input-invest-onetime');
            
            const costY1 = investAnnual + investOneTime;
            const costY2 = investAnnual;
            const costY3 = investAnnual;

            // Calculate ROI % = ((Return - Cost) / Cost) * 100
            // Guard against divide by zero
            const roiY1 = costY1 > 0 ? ((savingsY1 - costY1) / costY1) * 100 : 0;
            const roiY2 = costY2 > 0 ? ((savingsY2 - costY2) / costY2) * 100 : 0;
            const roiY3 = costY3 > 0 ? ((savingsY3 - costY3) / costY3) * 100 : 0;

            state.roi = [roiY1, roiY2, roiY3];

            const y1 = savingsY1; // For display on card
            
            if (document.getElementById('summary-total-savings')) document.getElementById('summary-total-savings').innerText = toCurrency(y1);
            if (document.getElementById('summary-roi-y1')) document.getElementById('summary-roi-y1').innerText = roiY1.toFixed(0) + '%';
            if (document.getElementById('summary-total-3yr')) document.getElementById('summary-total-3yr').innerText = toCurrency(savingsY1 + savingsY2 + savingsY3);
        }

        function renderChart() {
            const canvas = document.getElementById('roiChart');
            if (!canvas) return; // Guard clause
            
            const ctx = canvas.getContext('2d');
            if (roiChart) roiChart.destroy();

            // Check toggles
            const sTog = document.getElementById('toggle-safety');
            const rTog = document.getElementById('toggle-rework');
            const scTog = document.getElementById('toggle-schedule');
            
            const sOn = sTog ? sTog.checked : true;
            const rOn = rTog ? rTog.checked : true;
            const scOn = scTog ? scTog.checked : true;

            // Prepare datasets conditionally
            const datasets = [];
            
            // ROI Line (Right Axis) - Added First so it renders on top if using 'order' property, 
            // but chart.js renders datasets in order. Lines usually render on top of bars automatically if mixed.
            datasets.push({
                type: 'line',
                label: 'ROI %',
                data: state.roi,
                borderColor: '#1A1A1A',
                borderWidth: 3,
                pointBackgroundColor: '#1A1A1A',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                yAxisID: 'y1',
                order: 0 // Render on top
            });

            if (sOn) {
                // Safety: Orange
                datasets.push({ 
                    label: 'Incident Reduction', 
                    data: [state.safety, state.safety * 1.1, state.safety * 1.25], 
                    backgroundColor: '#D95D2A', 
                    borderRadius: 6,
                    yAxisID: 'y',
                    order: 1
                });
            }
            if (rOn) {
                // Rework: Black
                datasets.push({ 
                    label: 'Rework Reduction', 
                    data: [state.rework, state.rework * 1.1, state.rework * 1.25], 
                    backgroundColor: '#4B5563', // Changed to Dark Gray to distinct from black line
                    borderRadius: 6,
                    yAxisID: 'y',
                    order: 1
                });
            }
            if (scOn) {
                // Schedule: Tan
                datasets.push({ 
                    label: 'Schedule Improvement', 
                    data: [state.schedule, state.schedule * 1.1, state.schedule * 1.25], 
                    backgroundColor: '#EAE3D9', 
                    borderRadius: 6,
                    yAxisID: 'y',
                    order: 1
                });
            }

            roiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Year 1', 'Year 2', 'Year 3'],
                    datasets: datasets
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: { 
                        x: { stacked: true }, 
                        y: { 
                            type: 'linear',
                            display: true,
                            position: 'left',
                            stacked: true, 
                            ticks: { callback: (v) => toShort(v) },
                            title: { display: true, text: 'Realized Savings ($)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false, // only want the grid lines for one axis to show up
                            },
                            ticks: { callback: (v) => v.toFixed(0) + '%' },
                            title: { display: true, text: 'Return on Investment (%)' }
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.type === 'line') {
                                        label += Math.round(context.raw) + '%';
                                    } else {
                                        label += toCurrency(context.raw);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        document.querySelectorAll('input').forEach(i => i.addEventListener('input', calculate));
        window.onload = () => { lucide.createIcons(); calculate(); };
    </script>
</body>
</html>
